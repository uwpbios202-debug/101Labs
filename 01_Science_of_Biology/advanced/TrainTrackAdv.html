<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Modified CSS from source file to fit requirements and ensure high contrast */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f7f9;
        }

        h1 {
            color: #2c3e50;
        }

        .controls-container {
            width: 90%;
            max-width: 1100px;
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .instructions-block {
            border: 1px solid #bdc3c7;
            background-color: #fff;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 1100px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .selector-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-group label {
            font-weight: bold;
            color: #34495e;
        }

        /* Pill Button Styling for Level Selector */
        .pill-button-group {
            display: flex;
            border: 2px solid #3498db;
            border-radius: 5px;
            overflow: hidden;
        }

        .pill-button-group button {
            padding: 8px 15px;
            font-size: 1em;
            font-weight: normal;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            background-color: white;
            color: #3498db;
            border-right: 1px solid #3498db;
        }

        .pill-button-group button:last-child {
            border-right: none;
        }

        .pill-button-group button.active {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        .pill-button-group button:hover:not(.active) {
            background-color: #ecf0f1;
        }

        /* Radio Group Styling for Type Selector */
        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            padding: 8px 15px;
            font-size: 1em;
            cursor: pointer;
            border: 2px solid #2ecc71;
            border-radius: 5px;
            color: #2ecc71;
            background-color: white;
            transition: all 0.2s;
            margin-left: 5px;
        }

        .radio-group input[type="radio"]:checked+label {
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
        }

        /* General Inputs and Selects (derived from original source) */
        select {
            padding: 10px;
            font-size: 1.1em;
            border-radius: 5px;
            border: 2px solid #3498db;
            background-color: white;
            cursor: pointer;
        }

        .ref-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        .ref-table th,
        .ref-table td {
            border: 1px solid #bdc3c7;
            padding: 2px 4px;
            text-align: center;
            height: 20px;
        }

        .ref-table th {
            background-color: #34495e;
            color: white;
        }

        .ref-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Train Track Styling (derived from original source) */
        .track-wrapper {
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .step-label {
            align-self: flex-start;
            font-weight: bold;
            color: #e67e22;
            margin-bottom: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .train-track-model {
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .track-connector {
            font-size: 2em;
            color: #bdc3c7;
            margin: 5px 0;
        }

        .cell {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 140px;
            position: relative;
            transition: all 0.3s ease;
        }

        .cell.hidden {
            display: none;
        }

        .track-line {
            width: 100%;
            height: 4px;
            background-color: #2c3e50;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0;
        }

        .cell:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #2c3e50;
            z-index: 1;
        }

        .cell.no-border::after {
            display: none;
        }

        .numerator,
        .denominator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 10px;
            z-index: 2;
            height: 60px;
            width: 100%;
        }

        input {
            font-family: inherit;
            font-size: 1.1em;
            text-align: center;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            padding: 5px;
            margin: 0 4px;
            transition: border-color 0.2s;
        }

        input:focus {
            border-color: #3498db;
            outline: none;
        }

        input[readonly] {
            background-color: #e9ecef;
            color: #7f8c8d;
            border-color: #dcdcdc;
            cursor: not-allowed;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .val-input {
            width: 70px;
        }

        .unit-input {
            width: 80px;
        }

        .fixed-one {
            font-size: 1.5em;
            font-weight: bold;
            color: #555;
            margin-right: 5px;
            user-select: none;
        }

        .scientific-group {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .base-ten {
            font-size: 1.4em;
            font-weight: bold;
            margin-right: 2px;
        }

        .exponent-input {
            width: 45px;
            height: 25px;
            font-size: 0.9em;
            margin-bottom: 15px;
            border: 2px solid #95a5a6;
        }

        .rewrite-input {
            margin-bottom: 0;
        }

        .equals-sign {
            font-size: 2.5em;
            color: #2c3e50;
            padding: 0 15px;
        }

        .right-column-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 350px;
            margin-left: 10px;
        }

        .info-box {
            display: flex;
            flex-direction: column;
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            width: 100%;
        }

        .result-row {
            margin-bottom: 10px;
            width: 100%;
        }

        .result-label {
            display: block;
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .result-input-wrapper {
            display: flex;
            align-items: center;
        }

        .answer-input {
            width: 120px;
            text-align: left;
        }

        .final-unit-label {
            margin-left: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .correct {
            border-color: #27ae60 !important;
            background-color: #eafaf1 !important;
        }

        .incorrect {
            border-color: #c0392b !important;
            background-color: #fdedec !important;
        }

        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-new {
            background-color: #f1c40f;
            color: #333;
        }

        .btn-new:hover {
            background-color: #f39c12;
        }

        .btn-calc {
            background-color: #2ecc71;
            color: white;
        }

        .btn-calc:hover {
            background-color: #27ae60;
        }

        .btn-check {
            background-color: #3498db;
            color: white;
        }

        .btn-check:hover {
            background-color: #2980b9;
        }

        .status-msg {
            font-weight: bold;
            margin-left: 10px;
            font-size: 1.1em;
        }

        .cancelled {
            text-decoration: line-through;
            text-decoration-thickness: 3px;
            text-decoration-color: #e74c3c;
            opacity: 0.6;
        }

        .mcat-badge {
            background-color: #9b59b6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Custom Dropdown/Input Group for Compound Units */
        .compound-unit-selector {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .unit-part-input {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px;
        }

        .unit-part-input select {
            padding: 5px;
            font-size: 0.9em;
            border: none;
            border-radius: 0;
        }

        .unit-part-input select:first-child {
            border-right: 1px solid #ccc;
        }

        .compound-unit-display {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }

        .unit-frac-line {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
<style>
.bios-nav {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #016836;
  border-bottom: 2px solid #FFD100;
}
.bios-nav-inner {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 4px 8px;
}
.bios-home {
  color: white;
  font-weight: 700;
  text-decoration: none;
  letter-spacing: .5px;
}
.bios-toggle {
  display: none;
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
}
.bios-menus {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.bios-menu { position: relative; }
.bios-trigger {
  background: none;
  border: none;
  color: white;
  font-weight: 600;
  cursor: pointer;
  padding: 2px 4px;
}
.bios-trigger.active {
  border-bottom: 2px solid #FFD100;
}
.bios-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid #ccc;
  min-width: 160px;
  z-index: 1001;
}
.bios-dropdown a {
  display: block;
  padding: 6px 10px;
  color: #212721;
  text-decoration: none;
}
.bios-dropdown a:hover {
  background: #EFECE2;
}
.bios-menu:hover .bios-dropdown,
.bios-menu:focus-within .bios-dropdown {
  display: block;
}
@media (max-width: 768px) {
  .bios-toggle { display: block; }
  .bios-menus {
    display: none;
    flex-direction: column;
    background: #016836;
    width: 100%;
  }
  .bios-menus.open { display: flex; }
  .bios-dropdown {
    position: static;
    border: none;
  }
}
</style>
</head>

<body>
<nav class="bios-nav">
  <div class="bios-nav-inner">
    <a href="../index.html" class="bios-home">BIOS101</a>
    <button class="bios-toggle" aria-label="Toggle menu">â˜°</button>
    <div class="bios-menus" id="biosMenus"></div>
  </div>
</nav>
    <div
        style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin-bottom: 10px;">
        <a href="index.html" style="color: #333; text-decoration: none; font-size: 1em;">← Back to Hub</a>
        <h3 style="margin: 0; position: absolute; left: 50%; transform: translateX(-50%);">🚆 Advanced Metric Conversion
            — Compound Units <span class="mcat-badge">MCAT Edition</span></h3>
        <div style="width: 100px;"></div>
    </div>

    <div class="controls-container">

        <div class="radio-group" role="radiogroup" aria-label="Conversion Type">
            <input type="radio" id="type-conc" name="conversion-type" value="concentration" checked
                onchange="generateProblem()">
            <label for="type-conc" aria-checked="true">Concentration</label>
            <input type="radio" id="type-density" name="conversion-type" value="density" onchange="generateProblem()">
            <label for="type-density" aria-checked="false">Density</label>
        </div>

        <div class="pill-button-group" role="group" aria-label="Difficulty Level">
            <button id="level-medium" class="active" onclick="setLevel('medium', this)" aria-pressed="true">Level 2:
                Medium (2 Steps)</button>
            <button id="level-hard" onclick="setLevel('hard', this)" aria-pressed="false">Level 3: Hard (3
                Steps)</button>
        </div>

        <button class="btn-new" onclick="generateProblem()">🔄 New Problem</button>
    </div>

    <div class="instructions-block" style="margin: 0; padding: 0;">
        <p id="problem-text"
            style="font-size: 1.3em; font-weight: bold; color: #2c3e50; margin: 2px 0 4px 0; padding: 0; line-height: 1.2;">
            Select Type and Level, then click 'New Problem'</p>
        <p style="margin: 6px 0 2px 0; padding: 0;"><strong>Instructions (Dimensional Analysis):</strong></p>
        <ul style="margin: 0 0 6px 0; padding: 0 0 0 20px;">
            <li style="margin: 0 0 2px 0; padding: 0;"><strong>Step 1:</strong> Set up conversion factors. Enter
                **Units** and **Exponents**. Click on units to show **Cancellation**.</li>
            <li style="margin: 0 0 2px 0; padding: 0;"><strong>Step 2:</strong> Rewrite factors by moving Exponents to
                numerator. <span style="color:#e74c3c; font-weight:bold;">Flip the signs!</span></li>
            <li style="margin: 0; padding: 0;"><strong>Step 3:</strong> Calculate and Check your final answer.</li>
        </ul>
    </div>

    <div style="display: flex; align-items: flex-start; gap: 10px;">
        <div class="track-wrapper">
            <div class="step-label">Step 1: Set up Units & Powers</div>
            <div class="train-track-model" id="step1-track">
                <div class="cell" id="start-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <input type="text" id="start-val" class="val-input" placeholder="Value"
                            oninput="validateInput(this)" aria-label="Starting Value">
                        <div class="compound-unit-display" id="start-unit-display"></div>
                    </div>
                    <div class="denominator"></div>
                </div>

                <div class="cell" id="step-1-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <span class="fixed-one">1</span>
                        <input type="text" id="unit-n1" class="unit-input unit-box" placeholder="Unit"
                            onfocus="this.select()" aria-label="Conversion Factor 1 Numerator Unit">
                    </div>
                    <div class="denominator">
                        <div class="scientific-group">
                            <span class="base-ten">10</span>
                            <input type="number" id="exp-d1" class="exponent-input" placeholder="?"
                                onfocus="this.select()" aria-label="Conversion Factor 1 Denominator Exponent">
                        </div>
                        <input type="text" id="unit-d1" class="unit-input unit-box" placeholder="Unit"
                            onfocus="this.select()" aria-label="Conversion Factor 1 Denominator Unit">
                    </div>
                </div>

                <div class="cell hidden" id="step-2-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <span class="fixed-one">1</span>
                        <input type="text" id="unit-n2" class="unit-input unit-box" placeholder="Unit"
                            onfocus="this.select()" aria-label="Conversion Factor 2 Numerator Unit">
                    </div>
                    <div class="denominator">
                        <div class="scientific-group">
                            <span class="base-ten">10</span>
                            <input type="number" id="exp-d2" class="exponent-input" placeholder="?"
                                onfocus="this.select()" aria-label="Conversion Factor 2 Denominator Exponent">
                        </div>
                        <input type="text" id="unit-d2" class="unit-input unit-box" placeholder="Unit"
                            onfocus="this.select()" aria-label="Conversion Factor 2 Denominator Unit">
                    </div>
                </div>

                <div class="cell hidden" id="step-3-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <span class="fixed-one">1</span>
                        <input type="text" id="unit-n3" class="unit-input unit-box" placeholder="Unit"
                            onfocus="this.select()" aria-label="Conversion Factor 3 Numerator Unit">
                    </div>
                    <div class="denominator">
                        <div class="scientific-group">
                            <span class="base-ten">10</span>
                            <input type="number" id="exp-d3" class="exponent-input" placeholder="?"
                                onfocus="this.select()" aria-label="Conversion Factor 3 Denominator Exponent">
                        </div>
                        <input type="text" id="unit-d3" class="unit-input unit-box" placeholder="Unit"
                            onfocus="this.select()" aria-label="Conversion Factor 3 Denominator Unit">
                    </div>
                </div>

                <div class="cell no-border">
                    <span class="equals-sign">=</span>
                    <div class="compound-unit-display" id="target-unit-display"></div>
                </div>
            </div>

            <div class="track-connector">⬇</div>

            <div class="step-label">Step 2: Rewrite (Move Denominators Up & Flip Signs)</div>
            <div class="train-track-model" id="step2-track">
                <div class="cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <input type="text" id="rewrite-val" class="val-input" readonly placeholder="Start Value">
                    </div>
                    <div class="denominator"></div>
                </div>

                <div class="cell" id="rewrite-1-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <div class="scientific-group">
                            <span class="base-ten">× 10</span>
                            <input type="number" id="exp-flip-1" class="exponent-input rewrite-input" placeholder="?"
                                onfocus="this.select()" aria-label="Conversion Factor 1 Flipped Exponent">
                        </div>
                    </div>
                    <div class="denominator"></div>
                </div>

                <div class="cell hidden" id="rewrite-2-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <div class="scientific-group">
                            <span class="base-ten">× 10</span>
                            <input type="number" id="exp-flip-2" class="exponent-input rewrite-input" placeholder="?"
                                onfocus="this.select()" aria-label="Conversion Factor 2 Flipped Exponent">
                        </div>
                    </div>
                    <div class="denominator"></div>
                </div>

                <div class="cell hidden" id="rewrite-3-cell">
                    <div class="track-line"></div>
                    <div class="numerator">
                        <div class="scientific-group">
                            <span class="base-ten">× 10</span>
                            <input type="number" id="exp-flip-3" class="exponent-input rewrite-input" placeholder="?"
                                onfocus="this.select()" aria-label="Conversion Factor 3 Flipped Exponent">
                        </div>
                    </div>
                    <div class="denominator"></div>
                </div>

                <div class="cell no-border"><span class="equals-sign">=</span></div>
            </div>
        </div>

        <div class="right-column-stack">
            <div class="info-box">
                <h3 style="margin: 0 0 5px 0; color:#2c3e50; font-size:1em;">Metric Prefixes</h3>
                <table class="ref-table">
                    <thead>
                        <tr>
                            <th>Prefix</th>
                            <th>Sym</th>
                            <th>10<sup>x</sup></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>kilo</td>
                            <td>k</td>
                            <td>10<sup>3</sup></td>
                        </tr>
                        <tr>
                            <td><strong>Base</strong></td>
                            <td>(m,g,L,mol)</td>
                            <td>10<sup>0</sup></td>
                        </tr>
                        <tr>
                            <td>deci</td>
                            <td>d</td>
                            <td>10<sup>-1</sup></td>
                        </tr>
                        <tr>
                            <td>centi</td>
                            <td>c</td>
                            <td>10<sup>-2</sup></td>
                        </tr>
                        <tr>
                            <td>milli</td>
                            <td>m</td>
                            <td>10<sup>-3</sup></td>
                        </tr>
                        <tr>
                            <td>micro</td>
                            <td>µ</td>
                            <td>10<sup>-6</sup></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="info-box" id="mcat-conversions">
                <h3 style="margin: 0 0 5px 0; color:#9b59b6; font-size:1em;">MCAT Core Unit Equalities</h3>
                <table class="ref-table">
                    <tbody>
                        <tr>
                            <td>1 M = 1 mol/L</td>
                        </tr>
                        <tr>
                            <td>1 L = 10<sup>3</sup> mL</td>
                        </tr>
                        <tr>
                            <td>1 mL = 1 cm<sup>3</sup></td>
                        </tr>
                        <tr>
                            <td>1 m<sup>3</sup> = 10<sup>3</sup> L</td>
                        </tr>
                        <tr>
                            <td>1 mol = 10<sup>3</sup> mmol</td>
                        </tr>
                        <tr>
                            <td>1 mmol = 10<sup>3</sup> μmol</td>
                        </tr>
                        <tr>
                            <td>1 kg = 10<sup>3</sup> g</td>
                        </tr>
                        <tr>
                            <td>1 g = 10<sup>3</sup> mg</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="info-box">
                <h3 style="margin-top:0; color:#2c3e50;">Step 3: Solve</h3>
                <div class="result-row">
                    <label class="result-label">Scientific Notation (3 sig figs):</label>
                    <div class="result-input-wrapper">
                        <input type="text" id="ans-sci" class="answer-input" placeholder="a.bce±d" readonly
                            aria-label="Final Answer in Scientific Notation">
                        <span class="final-unit-label target-unit-display"></span>
                    </div>
                </div>
                <div class="result-row">
                    <label class="result-label">Decimal (3 sig figs):</label>
                    <div class="result-input-wrapper">
                        <input type="text" id="ans-dec" class="answer-input" placeholder="0.000..." readonly
                            aria-label="Final Answer in Decimal Form">
                        <span class="final-unit-label target-unit-display"></span>
                    </div>
                </div>
                <div id="setup-feedback" style="margin-top:10px; font-size: 0.95em; font-weight:bold;"></div>
            </div>
        </div>
    </div>

    <div class="btn-container">
        <button class="btn-calc" onclick="calculateSetup()">1. Verify Setup & Signs</button>
        <button class="btn-check" onclick="checkFinalUnit()">2. Check Final Unit Match</button>
        <span id="check-status" class="status-msg"></span>
    </div>

    <div
        style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; width: 90%; max-width: 1100px; background-color: #f8f8f8;">
        <h3 style="margin-top: 0;">Custom Problem Setup</h3>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">

            <div class="compound-unit-selector">
                <label>Start Unit:</label>
                <div class="unit-part-input">
                    <select id="custom-start-num-pre" aria-label="Starting Numerator Prefix"
                        onchange="updateCustomUnits()">
                        <option value="">(None)</option>
                        <option value="k">k</option>
                        <option value="d">d</option>
                        <option value="c">c</option>
                        <option value="m">m</option>
                        <option value="µ">µ</option>
                    </select>
                    <select id="custom-start-num-unit" aria-label="Starting Numerator Unit"
                        onchange="updateCustomUnits()">
                        <option value="mol">mol</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                    </select>
                </div>
                <span class="unit-frac-line">/</span>
                <div class="unit-part-input">
                    <select id="custom-start-den-pre" aria-label="Starting Denominator Prefix"
                        onchange="updateCustomUnits()">
                        <option value="">(None)</option>
                        <option value="k">k</option>
                        <option value="d">d</option>
                        <option value="c">c</option>
                        <option value="m">m</option>
                        <option value="µ">µ</option>
                    </select>
                    <select id="custom-start-den-unit" aria-label="Starting Denominator Unit"
                        onchange="updateCustomUnits()">
                        <option value="L">L</option>
                        <option value="g">g</option>
                        <option value="m³">m³</option>
                        <option value="cm³">cm³</option>
                    </select>
                </div>
            </div>

            <div class="compound-unit-selector">
                <label>Target Unit:</label>
                <div class="unit-part-input">
                    <select id="custom-target-num-pre" aria-label="Target Numerator Prefix"
                        onchange="updateCustomUnits()">
                        <option value="">(None)</option>
                        <option value="k">k</option>
                        <option value="d">d</option>
                        <option value="c">c</option>
                        <option value="m">m</option>
                        <option value="µ">µ</option>
                    </select>
                    <select id="custom-target-num-unit" aria-label="Target Numerator Unit"
                        onchange="updateCustomUnits()">
                        <option value="mol">mol</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                    </select>
                </div>
                <span class="unit-frac-line">/</span>
                <div class="unit-part-input">
                    <select id="custom-target-den-pre" aria-label="Target Denominator Prefix"
                        onchange="updateCustomUnits()">
                        <option value="">(None)</option>
                        <option value="k">k</option>
                        <option value="d">d</option>
                        <option value="c">c</option>
                        <option value="m">m</option>
                        <option value="µ">µ</option>
                    </select>
                    <select id="custom-target-den-unit" aria-label="Target Denominator Unit"
                        onchange="updateCustomUnits()">
                        <option value="L">L</option>
                        <option value="g">g</option>
                        <option value="m³">m³</option>
                        <option value="cm³">cm³</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <label for="custom-start-val">Custom Start Value:</label>
                <input type="text" id="custom-start-val" value="1.0" class="val-input" placeholder="e.g., 1.0"
                    oninput="updateCustomUnits()">
                <button class="btn-new" onclick="generateCustomProblem()">Generate Custom Problem</button>
            </div>
        </div>
        <p style="margin-top: 10px; font-weight: bold;" id="custom-unit-display-status"></p>
        <p style="color:#e74c3c; font-weight: bold;" id="custom-unit-validation-msg"></p>
    </div>


    <script>
        // --- Core Data Structures ---
        const prefixes = [
            { sym: 'k', exp: 3 }, { sym: '', exp: 0 },
            { sym: 'd', exp: -1 }, { sym: 'c', exp: -2 }, { sym: 'm', exp: -3 },
            { sym: 'µ', exp: -6 }
        ];

        // Conversions defined as 1 <unitA> = 10^x <unitB>
        const unitEqualities = {
            'M': { unitB: 'mol/L', exponent: 0, steps: 1 }, // 1 M = 1 mol/L (definition)
            'L': { unitB: 'mL', exponent: 3, steps: 1 },    // 1 L = 10^3 mL
            'mL': { unitB: 'cm³', exponent: 0, steps: 1 },  // 1 mL = 1 cm³ (definition)
            'm³': { unitB: 'L', exponent: 3, steps: 1 },    // 1 m³ = 10^3 L
            'mol': { unitB: 'mmol', exponent: 3, steps: 1 },// 1 mol = 10^3 mmol
            'mmol': { unitB: 'μmol', exponent: 3, steps: 1 },// 1 mmol = 10^3 μmol
            'kg': { unitB: 'g', exponent: 3, steps: 1 },    // 1 kg = 10^3 g
            'g': { unitB: 'mg', exponent: 3, steps: 1 }     // 1 g = 10^3 mg
        };

        const problemSets = {
            'concentration': {
                'level2': [
                    { start: '0.25 mol/L', end: 'mmol/mL' },
                    { start: '75.0 μmol/L', end: 'mmol/mL' },
                    { start: '3.00 mmol/mL', end: 'mol/L' },
                    { start: '2.40 mol/m³', end: 'mol/L' }
                ],
                'level3': [
                    { start: '5.00 μmol/mL', end: 'mol/m³' },
                    { start: '0.800 mol/L', end: 'μmol/mL' },
                    { start: '2.50 mmol/mL', end: 'mol/m³' },
                    { start: '4.20 μmol/L', end: 'mmol/m³' }
                ],
                numUnits: ['mol', 'mmol', 'μmol', 'M'],
                denUnits: ['L', 'mL', 'μL', 'cm³', 'm³']
            },
            'density': {
                'level2': [
                    { start: '1.20 g/mL', end: 'kg/L' },
                    { start: '850. mg/mL', end: 'g/cm³' },
                    { start: '0.950 g/cm³', end: 'g/mL' },
                    { start: '1000. kg/m³', end: 'g/cm³' }
                ],
                'level3': [
                    { start: '1000. kg/m³', end: 'g/mL' },
                    { start: '0.900 g/cm³', end: 'mg/L' },
                    { start: '2.50 mg/mL', end: 'kg/m³' },
                    { start: '7.50 g/L', end: 'mg/m³' }
                ],
                numUnits: ['kg', 'g', 'mg'],
                denUnits: ['m³', 'L', 'mL', 'cm³']
            }
        };

        // --- Global State ---
        let currentProblem = {
            startVal: 0,
            startUnit: '',
            targetUnit: '',
            type: 'concentration',
            level: 'medium',
            activeSteps: 2
        };
        let currentSolution = null;
        const SIG_FIGS = 3;

        // --- Utility Functions ---
        function setLevel(level, button) {
            currentProblem.level = level;
            currentProblem.activeSteps = level === 'medium' ? 2 : 3;
            document.querySelectorAll('.pill-button-group button').forEach(btn => btn.classList.remove('active', 'aria-pressed'));
            button.classList.add('active');
            button.setAttribute('aria-pressed', 'true');
            generateProblem();
        }

        function getPrefix(unit) {
            if (unit === 'mol' || unit === 'g' || unit === 'L' || unit === 'M') return { sym: '', exp: 0, base: unit };
            for (const p of prefixes) {
                if (p.sym && unit.startsWith(p.sym)) {
                    // Handle 'm' for milli vs. 'm' base unit (meter/mol/mass)
                    if (p.sym === 'm' && unit === 'm³') continue; // m³ is a base unit for volume
                    if (p.sym === 'm' && unit.length === 1) continue; // Base unit 'm' (meter) not used in MCAT problems here
                    if (p.sym === 'm' && unit === 'mol') continue; // Base unit 'mol'

                    const baseUnit = unit.substring(p.sym.length);
                    if (baseUnit in unitEqualities || ['mol', 'g', 'L', 'm³', 'cm³', 'kg', 'mg', 'mmol', 'μmol'].includes(baseUnit)) {
                        return { sym: p.sym, exp: p.exp, base: baseUnit };
                    }
                }
            }
            return { sym: '', exp: 0, base: unit };
        }

        function parseCompoundUnit(compoundUnit) {
            const parts = compoundUnit.split('/');
            const numerator = parts[0].trim();
            const denominator = parts.length > 1 ? parts[1].trim() : '';

            const numPrefix = getPrefix(numerator);
            const denPrefix = getPrefix(denominator);

            return {
                num: { unit: numerator, prefix: numPrefix.sym, base: numPrefix.base, exp: numPrefix.exp },
                den: { unit: denominator, prefix: denPrefix.sym, base: denPrefix.base, exp: denPrefix.exp }
            };
        }

        function formatSci(value) {
            if (value === 0) return '0.00e0';
            const sigVal = value.toPrecision(SIG_FIGS);
            return parseFloat(sigVal).toExponential().replace('e+', 'e');
        }

        function formatDec(value) {
            if (value === 0) return '0.00';
            return parseFloat(value.toPrecision(SIG_FIGS)).toLocaleString('en-US', { useGrouping: false });
        }

        // --- Unit Matching & Step Enforcement ---

        /*
         * Determines the minimum number of conversion factors (steps) needed to convert
         * the start unit to the target unit.
         * The factors are:
         * 1. Numerator Prefix Change
         * 2. Denominator Prefix Change
         * 3. Unit Base Change (e.g., L <-> mL or mol <-> mmol)
         */
        function determineMinSteps(startUnit, targetUnit) {
            const start = parseCompoundUnit(startUnit);
            const target = parseCompoundUnit(targetUnit);
            let steps = 0;

            if (start.num.unit === target.num.unit && start.den.unit === target.den.unit) {
                return 0; // Same unit
            }

            // Step 1: Numerator conversion
            // This counts as a step if the prefix changes OR the base unit changes.
            if (start.num.unit !== target.num.unit) {
                // If it's a simple prefix change (like µmol to mol), this is one step: 1 mol / 10^6 µmol
                // If the base changes (like M to mol/L), we assume M is handled by a separate conversion (1 M = 1 mol/L)
                // The complexity is in identifying the type of change.

                // Simplified: Check if prefixes differ, OR if the non-prefixed parts differ.
                const startNumBase = start.num.base || start.num.unit;
                const targetNumBase = target.num.base || target.num.unit;

                if (startNumBase !== targetNumBase) {
                    // Base unit change: e.g. mol -> mmol. This is a unit-to-unit step.
                    // Or, M -> mol/L. This is a unit-to-compound step.
                    // This change often accounts for the prefix change too (1 mol = 10^3 mmol).
                    // We only count it as ONE step.
                    steps++;
                } else if (start.num.prefix !== target.num.prefix) {
                    // Pure prefix change: e.g. µL -> L.
                    steps++;
                }
            }

            // Step 2: Denominator conversion
            // Similar logic for the denominator.
            if (start.den.unit !== target.den.unit) {
                const startDenBase = start.den.base || start.den.unit;
                const targetDenBase = target.den.base || target.den.unit;

                if (startDenBase !== targetDenBase) {
                    // Base unit change: e.g. L -> mL. This is a unit-to-unit step.
                    steps++;
                } else if (start.den.prefix !== target.den.prefix) {
                    // Pure prefix change: e.g. cL -> L.
                    steps++;
                }
            }

            // This is a complex problem for a simple script. For MCAT-style problems,
            // we simplify based on the total number of distinct changes:
            // 1. Numerator unit change (unit base or prefix)
            // 2. Denominator unit change (unit base or prefix)
            // 3. Overall compound unit definition change (e.g., M to mol/L)

            // Re-evaluating the specific problem sets' steps:
            // Conc L2 (2 steps): mol/L -> mmol/mL (Num prefix change: mol->mmol, Den unit change: L->mL) = 2 steps
            // Conc L3 (3 steps): μmol/mL -> mol/m³ (Num: μmol->mol, Den: mL->m³) = 3 steps (two prefix/base steps + one L->m³ base step)
            // Density L2 (2 steps): g/mL -> kg/L (Num: g->kg, Den: mL->L) = 2 steps
            // Density L3 (3 steps): kg/m³ -> g/mL (Num: kg->g, Den: m³->mL) = 3 steps (kg->g, m³->L, L->mL)

            // The step count is the total number of non-identity conversion factors needed.
            // Simplified calculation: 1 if num changes, 1 if den changes. Max 2 for compound unit.
            // If num or den change requires multiple base-changes (e.g. m³ -> cm³ is 2 steps: m³->L, L->mL=cm³)

            const numChange = start.num.unit !== target.num.unit;
            const denChange = start.den.unit !== target.den.unit;

            let totalSteps = 0;
            if (numChange) totalSteps++;
            if (denChange) totalSteps++;

            // Hardcode adjustment for common 3-step MCAT problems:
            // A change from a large volume unit to a small one (m³ to mL/cm³) or vice-versa,
            // combined with a mass/mole prefix change (kg/mol to g/mmol/µmol)
            const is3StepVolumeChange = (start.den.unit === 'm³' && (target.den.unit === 'mL' || target.den.unit === 'cm³')) ||
                (target.den.unit === 'm³' && (start.den.unit === 'mL' || start.den.unit === 'cm³'));

            if (totalSteps === 2 && is3StepVolumeChange) {
                totalSteps = 3; // The m³ to mL/cm³ conversion takes two steps: m³->L and L->mL/cm³
            }

            // Molarity is an exception. M -> mol/L is a 0-step unit rewrite, but we treat it as 1 step if combined.
            if ((start.num.unit === 'M' || target.num.unit === 'M') && totalSteps === 0) {
                // If it's just M to mol/L
                return 1;
            } else if (start.num.unit === 'M') {
                // If starting with M, we need one step to go to mol/L, plus any other unit changes.
                // The provided problem sets don't start with M unless it's a 2-step problem.
                // For simplicity matching the problem sets:
                return currentProblem.activeSteps;
            }

            return totalSteps || (startUnit === targetUnit ? 0 : 1);
        }

        // --- Main Logic & UI Functions ---

        window.onload = function () {
            // Initialize with default settings
            document.getElementById('type-conc').checked = true;
            document.getElementById('level-medium').classList.add('active');
            generateProblem();
        };

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function validateInput(input) {
            const val = input.value;
            // Allow numbers, scientific notation format (e.g., 1.23e-4), and negative sign
            if (!/^-?\d*\.?\d*(e[+-]?\d+)?$/.test(val)) {
                input.value = val.slice(0, -1);
            }
        }

        function clearWorkspace() {
            document.querySelectorAll('input').forEach(i => {
                if (!i.readOnly) i.value = '';
                i.classList.remove('correct', 'incorrect', 'cancelled');
            });
            document.querySelectorAll('.answer-input').forEach(i => i.value = '');
            document.getElementById('setup-feedback').textContent = '';
            document.getElementById('check-status').textContent = '';
            currentSolution = null;

            // Hide/Show step cells based on current level
            const s2 = [document.getElementById('step-2-cell'), document.getElementById('rewrite-2-cell')];
            const s3 = [document.getElementById('step-3-cell'), document.getElementById('rewrite-3-cell')];

            s2.forEach(el => el.classList.toggle('hidden', currentProblem.activeSteps < 2));
            s3.forEach(el => el.classList.toggle('hidden', currentProblem.activeSteps < 3));
        }

        function generateProblem(customProblem) {
            currentProblem.type = document.querySelector('input[name="conversion-type"]:checked').value;
            currentProblem.level = document.querySelector('.pill-button-group button.active').id.replace('level-', '');
            currentProblem.activeSteps = currentProblem.level === 'medium' ? 2 : 3;

            clearWorkspace();

            let problem;
            if (customProblem) {
                problem = customProblem;
                currentProblem.startVal = problem.startVal;
                currentProblem.startUnit = problem.startUnit;
                currentProblem.targetUnit = problem.endUnit;
            } else {
                const problems = problemSets[currentProblem.type][currentProblem.level];
                problem = getRandomItem(problems);

                // Parse the start string (e.g., '5.00 μmol/mL')
                const parts = problem.start.split(' ');
                currentProblem.startVal = parts[0];
                currentProblem.startUnit = parts[1];
                currentProblem.targetUnit = problem.end;
            }

            document.getElementById('problem-text').innerHTML = `Convert **${currentProblem.startVal} ${currentProblem.startUnit}** to **${currentProblem.targetUnit}**`;
            document.getElementById('start-val').value = currentProblem.startVal;
            document.getElementById('rewrite-val').value = currentProblem.startVal;

            // Display compound units
            document.getElementById('start-unit-display').innerHTML = formatCompoundUnitDisplay(currentProblem.startUnit);
            document.getElementById('target-unit-display').innerHTML = formatCompoundUnitDisplay(currentProblem.targetUnit);
            document.querySelectorAll('.target-unit-display').forEach(el => el.innerHTML = formatCompoundUnitDisplay(currentProblem.targetUnit));

            // Re-apply event listeners for unit cancellation
            document.querySelectorAll('.unit-box').forEach(box => {
                box.removeEventListener('click', toggleCancelled);
                box.addEventListener('click', toggleCancelled);
            });
        }

        function generateCustomProblem() {
            const startNumPre = document.getElementById('custom-start-num-pre').value;
            const startNumUnit = document.getElementById('custom-start-num-unit').value;
            const startDenPre = document.getElementById('custom-start-den-pre').value;
            const startDenUnit = document.getElementById('custom-start-den-unit').value;
            const targetNumPre = document.getElementById('custom-target-num-pre').value;
            const targetNumUnit = document.getElementById('custom-target-num-unit').value;
            const targetDenPre = document.getElementById('custom-target-den-pre').value;
            const targetDenUnit = document.getElementById('custom-target-den-unit').value;
            const startVal = document.getElementById('custom-start-val').value;

            const startUnit = `${startNumPre}${startNumUnit}/${startDenPre}${startDenUnit}`;
            const endUnit = `${targetNumPre}${targetNumUnit}/${targetDenPre}${targetDenUnit}`;

            const minSteps = determineMinSteps(startUnit, endUnit);
            const activeSteps = currentProblem.level === 'medium' ? 2 : 3;

            document.getElementById('custom-unit-validation-msg').textContent = '';

            if (minSteps > activeSteps) {
                document.getElementById('custom-unit-validation-msg').textContent = `Error: This conversion requires a minimum of ${minSteps} steps, but you are in Level ${activeSteps}. Please choose target units that require ${activeSteps} steps or fewer.`;
                return;
            }
            if (minSteps === 0 || minSteps === 1) {
                document.getElementById('custom-unit-validation-msg').textContent = `Error: This conversion requires ${minSteps} steps, but Level ${activeSteps} requires at least 2 steps.`;
                return;
            }

            generateProblem({ startVal: startVal, startUnit: startUnit, endUnit: endUnit });
        }

        function formatCompoundUnitDisplay(compoundUnit) {
            const parts = compoundUnit.split('/');
            if (parts.length > 1) {
                return `<span>${parts[0]}</span><span class="unit-frac-line">/</span><span>${parts[1]}</span>`;
            }
            return `<span>${compoundUnit}</span>`;
        }

        function toggleCancelled() {
            if (this.value.trim() !== "") this.classList.toggle('cancelled');
        }

        function updateCustomUnits() {
            const startNumPre = document.getElementById('custom-start-num-pre').value;
            const startNumUnit = document.getElementById('custom-start-num-unit').value;
            const startDenPre = document.getElementById('custom-start-den-pre').value;
            const startDenUnit = document.getElementById('custom-start-den-unit').value;
            const targetNumPre = document.getElementById('custom-target-num-pre').value;
            const targetNumUnit = document.getElementById('custom-target-num-unit').value;
            const targetDenPre = document.getElementById('custom-target-den-pre').value;
            const targetDenUnit = document.getElementById('custom-target-den-unit').value;

            const startUnit = `${startNumPre}${startNumUnit}/${startDenPre}${startDenUnit}`;
            const endUnit = `${targetNumPre}${targetNumUnit}/${targetDenPre}${targetDenUnit}`;

            const minSteps = determineMinSteps(startUnit, endUnit);
            const activeSteps = currentProblem.level === 'medium' ? 2 : 3;

            document.getElementById('custom-unit-display-status').textContent = `Custom Units: ${startUnit} -> ${endUnit}. Minimum Steps: ${minSteps}.`;
            document.getElementById('custom-unit-validation-msg').textContent = '';

            if (minSteps > activeSteps) {
                document.getElementById('custom-unit-validation-msg').textContent = `This conversion requires ${minSteps} steps. Level ${activeSteps} is selected.`;
            } else if (minSteps < 2) {
                document.getElementById('custom-unit-validation-msg').textContent = `This conversion requires ${minSteps} steps. Level ${activeSteps} requires at least 2 steps.`;
            }
        }

        // --- Calculation and Validation ---

        /*
         * Calculates the total exponent change required for a conversion based on the
         * prefix/base unit change. This is the exponent for the denominator, E.g.,
         * Convert L -> mL (1 L = 10^3 mL). Denominator is 10^3.
         * Convert mL -> L (1 mL = 10^-3 L). Denominator is 10^-3.
         */
        function calculateRequiredExponent(oldUnit, newUnit) {
            const oldParsed = getPrefix(oldUnit);
            const newParsed = getPrefix(newUnit);

            // Case 1: Base Unit Change (e.g., L to mL, mol to mmol)
            // Use unitEqualities
            if (oldUnit in unitEqualities && newUnit === unitEqualities[oldUnit].unitB) {
                return unitEqualities[oldUnit].exponent; // E.g., 1 L = 10^3 mL -> exp is 3
            } else if (newUnit in unitEqualities && oldUnit === unitEqualities[newUnit].unitB) {
                return -unitEqualities[newUnit].exponent; // E.g., 1 mL = 10^-3 L -> exp is -3
            }

            // Case 2: Prefix Change (e.g., kL to L, or µL to L)
            // The relationship is 1 * <Base Unit> = 10^x * <Prefixed Unit>
            // The value * 10^Prefix_Old / 10^Prefix_New
            if (oldParsed.base === newParsed.base) {
                // To get from the prefixed unit to the base unit (numerator),
                // the conversion factor's denominator exponent is: prefix_exp_new - prefix_exp_old.
                // E.g., Convert µL (10^-6L) to L (10^0L). 
                // Conversion factor: 1 L / 10^6 µL. Denominator exponent: 6.
                // The required denominator exponent is: -(newPrefixExp - oldPrefixExp).
                // But since newUnit is in the numerator, and oldUnit in the denominator:
                // Factor is 10^(oldExp) / 10^(newExp)
                // The denominator should be 10^(newExp - oldExp)
                // E.g. c to m. newExp = -3, oldExp = -2. Exponent = -3 - (-2) = -1. Factor: 10^-1 m / 1 c
                // Wait, it's 1 * newUnit = 10^x * oldUnit
                // 1 cL = 10^-2 L. 1 mL = 10^-3 L.
                // 1 cL * (1 mL / 10^-1 cL) is wrong.

                // The factor in the denominator is 10^x * oldUnit. We need 1 * newUnit.
                // If old is base unit (exp=0) and new is prefixed (exp=P), 
                // Factor is: 1 * baseUnit / 10^P * prefixedUnit. Denom Exp is P. (Correct for old format)

                // Let's use the actual exponent for the unit in the denominator:
                // E.g., Convert L (denom) to mL (num). 1 L = 10^3 mL. Denom Exp is 3.
                // Convert L (denom) to kL (num). 1 L = 10^-3 kL. Denom Exp is -3.

                // The exponent is: (Exponent of new unit) - (Exponent of old unit)
                return oldParsed.exp - newParsed.exp;
            }

            // Case 3: Mixed (e.g., L to cm³)
            // This case relies on the user setting up multiple steps (L->mL, mL->cm³).

            // This function is complex. Given the constraints, we only need to validate the step,
            // not *solve* for the conversion path. We will simplify the calculation:

            const baseUnits = ['L', 'g', 'mol', 'm³', 'cm³', 'kg'];
            if (baseUnits.includes(oldUnit) && baseUnits.includes(newUnit)) {
                // If both are treated as 'base' for a known equality
                if (oldUnit in unitEqualities && newUnit === unitEqualities[oldUnit].unitB) {
                    return unitEqualities[oldUnit].exponent;
                }
                if (newUnit in unitEqualities && oldUnit === unitEqualities[newUnit].unitB) {
                    return -unitEqualities[newUnit].exponent;
                }
            }

            // If it's a prefix change, use the prefix exponents
            // Target unit (numerator) is 10^x relative to old unit (denominator).
            // Exponent should be: 
            return oldParsed.exp - newParsed.exp;
        }

        function calculateSetup() {
            const feedback = document.getElementById('setup-feedback');
            feedback.textContent = "";
            currentSolution = null;

            const startVal = parseFloat(document.getElementById('start-val').value);
            if (isNaN(startVal)) {
                feedback.textContent = "Error: Please enter a valid starting value.";
                feedback.style.color = "#e74c3c";
                return;
            }

            // 1. Check Unit Cancellation
            const stepUnits = [
                { id: 'start-unit-display', w: 1, unit: currentProblem.startUnit },
                { id: 'unit-n1', w: 1, expId: 'exp-d1', flipId: 'exp-flip-1' },
                { id: 'unit-d1', w: -1, expId: 'exp-d1', flipId: 'exp-flip-1' }
            ];
            if (currentProblem.activeSteps >= 2) {
                stepUnits.push({ id: 'unit-n2', w: 1, expId: 'exp-d2', flipId: 'exp-flip-2' }, { id: 'unit-d2', w: -1, expId: 'exp-d2', flipId: 'exp-flip-2' });
            }
            if (currentProblem.activeSteps >= 3) {
                stepUnits.push({ id: 'unit-n3', w: 1, expId: 'exp-d3', flipId: 'exp-flip-3' }, { id: 'unit-d3', w: -1, expId: 'exp-d3', flipId: 'exp-flip-3' });
            }

            let expTotal = 0;
            let setupValid = true;

            // Check Exponents and Flip Signs
            for (let i = 1; i <= currentProblem.activeSteps; i++) {
                const expD = document.getElementById(`exp-d${i}`);
                const expFlip = document.getElementById(`exp-flip-${i}`);
                const unitN = document.getElementById(`unit-n${i}`).value.trim();
                const unitD = document.getElementById(`unit-d${i}`).value.trim();

                expD.classList.remove('incorrect', 'correct');
                expFlip.classList.remove('incorrect', 'correct');

                const expDVal = parseFloat(expD.value);
                const expFlipVal = parseFloat(expFlip.value);

                if (isNaN(expDVal) || isNaN(expFlipVal) || unitN === '' || unitD === '') {
                    setupValid = false;
                    feedback.textContent = "Error: Fill in all unit and exponent fields.";
                    feedback.style.color = "#e74c3c";
                    break;
                }

                // Simplified Exponent Validation (just checking the flip)
                if (expFlipVal !== -1 * expDVal) {
                    setupValid = false;
                    feedback.textContent = `Step ${i} Error: The flipped exponent must be the negative of the denominator exponent (${expDVal}).`;
                    feedback.style.color = "#e74c3c";
                    expFlip.classList.add('incorrect');
                    break;
                } else {
                    expFlip.classList.add('correct');
                    expTotal += expFlipVal;
                }
            }

            if (!setupValid) return;


            // 2. Perform Calculation
            currentSolution = startVal * Math.pow(10, expTotal);

            document.getElementById('ans-sci').value = formatSci(currentSolution);
            document.getElementById('ans-dec').value = formatDec(currentSolution);

            feedback.textContent = `✅ Setup & Rewrite verified! Total Exponent: 10^${expTotal}. Final Value Calculated.`;
            feedback.style.color = "#27ae60";
        }

        function checkFinalUnit() {
            const status = document.getElementById('check-status');
            const feedback = document.getElementById('setup-feedback');

            if (currentSolution === null) {
                alert("Please click '1. Verify Setup & Signs' first.");
                return;
            }

            // Unit Tally Logic
            let tally = {};
            let unitsToTally = [];

            // Add initial unit parts (numerator +1, denominator -1)
            const startParts = currentProblem.startUnit.split('/');
            unitsToTally.push({ unit: startParts[0].trim(), w: 1, cancelled: false });
            if (startParts.length > 1) {
                unitsToTally.push({ unit: startParts[1].trim(), w: -1, cancelled: false });
            }

            // Add conversion factor unit parts
            for (let i = 1; i <= currentProblem.activeSteps; i++) {
                const unitN = document.getElementById(`unit-n${i}`);
                const unitD = document.getElementById(`unit-d${i}`);

                const unitNVal = unitN.value.trim();
                const unitDVal = unitD.value.trim();

                unitsToTally.push({ unit: unitNVal, w: 1, cancelled: unitN.classList.contains('cancelled') });
                unitsToTally.push({ unit: unitDVal, w: -1, cancelled: unitD.classList.contains('cancelled') });
            }

            // Tally non-cancelled units
            unitsToTally.forEach(item => {
                if (!item.cancelled) {
                    const parts = item.unit.split('/');
                    tally[parts[0]] = (tally[parts[0]] || 0) + item.w;
                    if (parts[1]) tally[parts[1]] = (tally[parts[1]] || 0) - item.w;
                }
            });

            // Target Unit Tally
            const targetParts = currentProblem.targetUnit.split('/');
            let targetTally = { [targetParts[0]]: 1 };
            if (targetParts.length > 1) targetTally[targetParts[1]] = -1;

            let match = true;
            for (let key in targetTally) if (tally[key] !== targetTally[key]) match = false;
            for (let key in tally) if (!targetTally[key] && tally[key] !== 0) match = false;

            if (match) {
                status.textContent = `✅ Final Unit Correct: ${currentProblem.targetUnit}`;
                status.style.color = "#27ae60";
                feedback.textContent += " & Unit match verified!";
            } else {
                status.textContent = `❌ Final Unit Incorrect. Check your cancellations!`;
                status.style.color = "#e74c3c";
                feedback.textContent = `❌ Unit Error! Final calculated value is correct, but the unit setup is wrong.`;
                feedback.style.color = "#e74c3c";
            }
        }

    </script>
<script>
(function() {
  function initNav() {
    var labs = [{"folder":"bios101-learning","title":"Metacognition"},{"folder":"01_Science_of_Biology","title":"Scientific Process"},{"folder":"02_Eukaryotes","title":"Eukaryotes"},{"folder":"03_Carbohydrates","title":"Carbohydrates"},{"folder":"04_Proteins","title":"Proteins"},{"folder":"05_Lipids","title":"Lipids"},{"folder":"06_Photosynthetic_Pigments","title":"Photosynthesis"},{"folder":"07_Nucleic Acids","title":"Nucleic Acids"},{"folder":"08_Mitosis","title":"Mitosis"},{"folder":"09_Meiosis","title":"Meiosis"},{"folder":"10_Genetics","title":"Genetics"}];
    var menus = document.getElementById('biosMenus');
    var path = location.pathname;
    if (!menus) return;
    labs.forEach(function(lab) {
      var m = document.createElement('div');
      m.className = 'bios-menu';
      var b = document.createElement('button');
      b.className = 'bios-trigger';
      b.textContent = lab.title;
      if (path.indexOf(lab.folder) !== -1) b.classList.add('active');
      var d = document.createElement('div');
      d.className = 'bios-dropdown';
      var bp = '../../' + lab.folder;
      d.innerHTML = '<a href="' + bp + '/index.html">Overview</a><a href="' + bp + '/prelab/prelab.html">Pre-Lab</a><a href="' + bp + '/during_lab/in-lab.html">In-Lab</a><a href="' + bp + '/postlab/postlab.html">Post-Lab</a><a href="' + bp + '/advanced/optional.html">Optional</a>';
      m.appendChild(b);
      m.appendChild(d);
      menus.appendChild(m);
    });
    var t = document.querySelector('.bios-toggle');
    if (t) t.onclick = function() { menus.classList.toggle('open'); };
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNav);
  } else {
    initNav();
  }
})();
</script>
</body>

</html>
